PROGRAM TESTDPOPREMAP
    IMPLICIT NONE
    INTEGER, PARAMETER :: NDST=5, NLINK=3, NW=1, NSRC=5
    DOUBLE PRECISION, DIMENSION(NDST) :: DST_ARRAY
    DOUBLE PRECISION, DIMENSION(NW, NLINK) :: MAP_WTS = RESHAPE((/0.5, 2.0, 1.0/), (/1, 3/))
    INTEGER, DIMENSION(NLINK) :: DST_ADD = (/1, 3, 4/)
    INTEGER, DIMENSION(NLINK) :: SRC_ADD = (/2, 4, 5/)
    DOUBLE PRECISION, DIMENSION(NSRC) :: SRC_ARRAY = (/0.0, 100.0, 0.0, 50.0, 20.0/)
    DOUBLE PRECISION :: XMSG = 0.0
    INTEGER :: N

    CALL DPOPREMAP(DST_ARRAY, MAP_WTS, DST_ADD, SRC_ADD, SRC_ARRAY, NDST, NLINK, NW, NSRC, XMSG)

    PRINT *, 'Resulting DST_ARRAY:'
    DO N = 1, NDST
        PRINT *, DST_ARRAY(N)
    END DO

CONTAINS

    SUBROUTINE DPOPREMAP(DST_ARRAY, MAP_WTS, DST_ADD, SRC_ADD, SRC_ARRAY, NDST, NLINK, NW, NSRC, XMSG)
        INTEGER, INTENT(IN) :: NLINK, NW, NDST, NSRC
        DOUBLE PRECISION, INTENT(IN) :: MAP_WTS(NW, NLINK)
        DOUBLE PRECISION, INTENT(OUT) :: DST_ARRAY(NDST)
        DOUBLE PRECISION, INTENT(IN) :: SRC_ARRAY(NSRC)
        INTEGER, INTENT(IN) :: DST_ADD(NLINK), SRC_ADD(NLINK)
        DOUBLE PRECISION, INTENT(IN) :: XMSG
        INTEGER :: N

        DO N = 1, NDST
            DST_ARRAY(N) = XMSG
        END DO

        DO N = 1, NLINK
            IF (SRC_ARRAY(SRC_ADD(N)) .NE. XMSG) THEN
                IF (DST_ARRAY(DST_ADD(N)) .EQ. XMSG) THEN
                    DST_ARRAY(DST_ADD(N)) = SRC_ARRAY(SRC_ADD(N)) * MAP_WTS(1, N)
                ELSE
                    DST_ARRAY(DST_ADD(N)) = DST_ARRAY(DST_ADD(N)) + SRC_ARRAY(SRC_ADD(N)) * MAP_WTS(1, N)
                END IF
            END IF
        END DO
    END SUBROUTINE DPOPREMAP

END PROGRAM TESTDPOPREMAP