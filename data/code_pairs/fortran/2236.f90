PROGRAM TestQSFNDP
  IMPLICIT NONE
  DOUBLE PRECISION :: ECCENT, SINPHI, COSPHI, RESULT

  ECCENT = 0.1D0
  SINPHI = 0.5D0
  COSPHI = SQRT(1.0D0 - SINPHI**2)

  RESULT = QSFNDP(ECCENT, SINPHI, COSPHI)
  PRINT *, 'Fortran Result: ', RESULT

CONTAINS

  DOUBLE PRECISION FUNCTION QSFNDP(ECCENT, SINPHI, COSPHI)
    IMPLICIT NONE
    DOUBLE PRECISION :: ECCENT, SINPHI, COSPHI
    DOUBLE PRECISION :: HALF, ONE, TWO, EPSLN, CON
    HALF = 0.5D0
    ONE = 1.0D0
    TWO = 2.0D0
    EPSLN = 1.0D-7

    IF (ECCENT < EPSLN) THEN
      QSFNDP = TWO * SINPHI
      RETURN
    END IF

    CON = ECCENT * SINPHI
    QSFNDP = (ONE - ECCENT**2) * (SINPHI / (ONE - CON**2) - &
         (HALF / ECCENT) * LOG((ONE - CON) / (ONE + CON)))
  END FUNCTION QSFNDP

END PROGRAM TestQSFNDP