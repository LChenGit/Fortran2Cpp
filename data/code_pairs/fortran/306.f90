MODULE ModuleDefs
  INTEGER, PARAMETER :: SEASINIT = 1, RATE = 2
END MODULE ModuleDefs

MODULE MODULEDATA
  USE ModuleDefs
  IMPLICIT NONE

  TYPE MulchType
     REAL :: MULCHMASS = 0.0
     REAL :: MULCHCOVER = 0.0
     REAL :: MULCHTHICK = 0.0
     REAL :: MULCHWAT = 0.0
     REAL :: MULCH_AM = 0.0
     REAL :: MUL_EXTFAC = 0.0
     REAL :: MULCHEVAP = 0.0
  END TYPE MulchType

CONTAINS

  SUBROUTINE MULCH_EVAP(DYNAMIC, MULCH, EOS, EM)
    USE ModuleDefs
    IMPLICIT NONE
    INTEGER, INTENT(IN) :: DYNAMIC
    REAL, INTENT(INOUT) :: EOS, EM
    TYPE(MulchType), INTENT(INOUT) :: MULCH
    REAL :: AM, EOM, EXTFAC, MAI
    REAL :: MULCHCOVER, MULCHMASS, MULCHTHICK, MULCHWAT
    REAL :: EM2, EOS2, EOS3

    IF (DYNAMIC == SEASINIT) THEN
      EM = 0.0
    ELSEIF (DYNAMIC == RATE) THEN
      MULCHMASS = MULCH%MULCHMASS
      MULCHCOVER = MULCH%MULCHCOVER
      MULCHTHICK = MULCH%MULCHTHICK
      MULCHWAT = MULCH%MULCHWAT
      AM = MULCH%MULCH_AM
      EXTFAC = MULCH%MUL_EXTFAC

      IF (MULCHCOVER > 1.E-6) THEN
        MAI = (AM * 1.E-5 * MULCHMASS) / MULCHCOVER
      ELSE
        MAI = 0.0
      ENDIF

      EOM = EOS * (1. - EXP(-EXTFAC * MAI))
      EM2 = MIN(EOM, MULCHWAT * 0.85)
      EM2 = MAX(EM2, 0.0) * MULCHCOVER
      EOS2 = EOS - EM2
      EOS3 = EOS * EXP(-EXTFAC * MAI) * MULCHCOVER + EOS * (1.0 - MULCHCOVER)
      EOS3 = MIN(EOS2, EOS3)

      EM = EM2
      EOS = EOS3
    ENDIF

    MULCH%MULCHEVAP = EM
  END SUBROUTINE MULCH_EVAP

END MODULE MODULEDATA