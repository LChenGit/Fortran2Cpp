! File: DPHYBRID.f90
PROGRAM DPHYBRIDTest
  IMPLICIT NONE
  INTEGER, PARAMETER :: MLON=2, NLAT=2, KLEV=2, KLEVI=3
  DOUBLE PRECISION, DIMENSION(KLEVI) :: HYA, HYB
  DOUBLE PRECISION, DIMENSION(MLON, NLAT) :: PSFC
  DOUBLE PRECISION, DIMENSION(MLON, NLAT, KLEV) :: PHY
  DOUBLE PRECISION, DIMENSION(MLON, NLAT, KLEVI) :: PI
  DOUBLE PRECISION :: PMSG
  INTEGER :: i, j, k

  ! Initialize test data
  HYA = (/1.0D0, 2.0D0, 3.0D0/)
  HYB = (/0.5D0, 0.25D0, 0.125D0/)
  PSFC = RESHAPE((/1000.0D0, 2000.0D0, 1500.0D0, 1000.0D0 /), SHAPE(PSFC))
  PMSG = 9999.0D0

  ! Call the subroutine
  CALL DPHYBRIDJRA55(HYA, HYB, PSFC, MLON, NLAT, KLEV, PHY, PMSG, KLEVI, PI)

  ! Output for verification
  PRINT *, 'PI Array:'
  DO k = 1, KLEVI
    PRINT *, 'Layer', k
    DO j = 1, NLAT
      PRINT *, (PI(i, j, k), i = 1, MLON)
    END DO
  END DO

  PRINT *, 'PHY Array:'
  DO k = 1, KLEV
    PRINT *, 'Level', k
    DO j = 1, NLAT
      PRINT *, (PHY(i, j, k), i = 1, MLON)
    END DO
  END DO

END PROGRAM DPHYBRIDTest

SUBROUTINE DPHYBRIDJRA55(HYA,HYB,PSFC,MLON,NLAT,KLEV,PHY,PMSG,KLEVI,PI)
  IMPLICIT NONE
  INTEGER MLON,NLAT,KLEV,KLEVI
  DOUBLE PRECISION HYA(KLEVI),HYB(KLEVI),PSFC(MLON,NLAT),PMSG
  DOUBLE PRECISION PHY(MLON,NLAT,KLEV), PI(MLON,NLAT,KLEVI)

  DOUBLE PRECISION DP
  INTEGER KL,NL,ML

  DO KL = 1,KLEVI
      DO NL = 1,NLAT
          DO ML = 1,MLON
             IF (PSFC(ML,NL).NE.PMSG) THEN
                 PI(ML,NL,KL) = HYA(KL) + HYB(KL)*PSFC(ML,NL)
             ELSE
                 PI(ML,NL,KL) = PMSG
             END IF
          END DO
      END DO
  END DO

  DO NL = 1,NLAT
    DO ML = 1,MLON
      DO KL = 1,KLEV
         IF (PSFC(ML,NL).NE.PMSG) THEN
             DP = PI(ML,NL,KL)-PI(ML,NL,KL+1)
             PHY(ML,NL,KL) = EXP((1/DP)*(PI(ML,NL,KL)*LOG(PI(ML,NL,KL)) -PI(ML,NL,KL+1)*LOG(PI(ML,NL,KL+1)))-1)      
         ELSE
             PHY(ML,NL,KL) = PMSG
         END IF
      END DO
    END DO
  END DO

  DO NL = 1,NLAT
    DO ML = 1,MLON
       PHY(ML,NL,KLEV) = 10D0
    END DO
  END DO

END SUBROUTINE DPHYBRIDJRA55